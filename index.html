<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <canvas id="canvas" style="border: 1px solid blue;"></canvas>
    <button>fhd</button>
    <script>

        var datas = [
            {
                text: '20积分1',
                rate: '0.1'
            },
            {
                text: '一张卡券2',
                rate: '0.1'
            },
            {
                text: '未中奖3',
                rate: '0.1'
            },
            {
                text: '未中奖4',
                rate: '0.1'
            },
            {
                text: '未中奖5',
                rate: '0.1'
            },
            {
                text: '未中奖6',
                rate: '0.1'
            },
            {
                text: '未中奖7',
                rate: '0.1'
            },
            {
                text: '未中奖8',
                rate: '0.1'
            },
            {
                text: '未中奖7',
                rate: '0.1'
            },
            {
                text: '未中奖8',
                rate: '0.1'
            }
        ];
        var awardIndex = 2;

        var Roulette = {
            ctx: null,
            config: {
              id: '',
              width: '200',
              height: '200',
              datas: '',
              awardIndex: 1,
              canvas: null,
              runTime: 10000,
              timeStart: new Date().getTime(),
              color1: '#F17F42',
              color2: '#CE6D39'
            },
            lastRotateAngle: function () {
              var awardAngle = 0;
              for (var i = 0; i < this.config.awardIndex; i++) {
                if (i === this.config.awardIndex - 1) {
                  awardAngle = awardAngle + 2 * Math.PI * (this.config.datas[i].rate / 2);
                } else {
                  awardAngle = awardAngle + 2 * Math.PI * this.config.datas[i].rate;
                }
              }

              return Math.PI * (2 - 1 / 2) - awardAngle;
            },
            draw: function () {
              this.ctx.save();

//              this.ctx.translate(this.config.width / 2, this.config.height / 2);

              var radius = 150;

              var startAngle = 0;
              var endAngle = 0;

              for (var i in this.config.datas) {
                this.ctx.save();
                this.ctx.beginPath();

                endAngle = startAngle + this.config.datas[i].rate * 2 * Math.PI;

                if (i%2 === 0) {
                  this.ctx.fillStyle = this.config.color1;
                } else {
                  this.ctx.fillStyle = this.config.color2;
                }

                this.ctx.moveTo(0, 0);
                this.ctx.lineTo(radius * Math.cos(startAngle), radius * Math.sin(startAngle));
                this.ctx.arc(0, 0, radius, startAngle, endAngle);
                this.ctx.fill();

                var textAngle = startAngle + (endAngle - startAngle) / 2;
                var textX = (0.8 * radius) * Math.cos(textAngle);
                var textY = (0.8 * radius) * Math.sin(textAngle);

                this.ctx.translate(textX, textY);
                this.ctx.rotate(Math.PI / 2 + textAngle);
                this.ctx.font = "14px serif";
                this.ctx.fillStyle = '#FFFFFF';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(this.config.datas[i].text, 0, 0);

                startAngle = endAngle;

                this.ctx.restore();
              }

              this.ctx.restore();
            },
            rotate: function () {
              this.ctx.save();


              var lastTime = this.config.runTime - (new Date().getTime() - this.config.timeStart);

              if (lastTime > 0) {
                this.ctx.clearRect(0, 0, this.config.width, this.config.height);
                this.ctx.beginPath();
                var rotateAngle = this.lastRotateAngle() + 2 * Math.PI - Math.pow(lastTime / 1000, 2) % (2 * Math.PI);
              } else {
                window.cancelAnimationFrame(this.draw);
                return;
              }

              this.ctx.rotate(rotateAngle);

              this.draw();

              this.ctx.restore();

              window.requestAnimationFrame(this.rotate.bind(this));
            },
            init: function (config) {
              this.config.id = config.id;
              this.config.width = config.width;
              this.config.height = config.height;
              this.config.datas = config.datas;
              this.config.awardIndex = config.awardIndex;

              this.config.canvas = document.getElementById(config.id);
              this.config.canvas.setAttribute('width', config.width);
              this.config.canvas.setAttribute('height', config.height);


              this.ctx = canvas.getContext('2d');

              this.ctx.translate(this.config.width / 2, this.config.height / 2);
              this.ctx.save();

              this.draw();

              var _this = this;
              document.getElementsByTagName('button')[0].onclick = function () {
                _this.rotate();
              }
            }
        };

        Roulette.init({
          id: 'canvas',
          width: 400,
          height: 400,
          datas: datas,
          awardIndex: awardIndex
        });
    </script>
</body>
</html>