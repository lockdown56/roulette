<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <div id="canvas">
        <canvas></canvas>
    </div>
<<<<<<< HEAD
=======
    <button>fhd</button>
>>>>>>> db001bc36c18675c178101c8a27736a91bed2a61
    <script>

        var datas = [
            {
                text: '20积分1',
                rate: '0.1'
            },
            {
                text: '一张卡券2',
                rate: '0.1'
            },
            {
                text: '未中奖3',
                rate: '0.1'
            },
            {
                text: '未中奖4',
                rate: '0.1'
            },
            {
                text: '未中奖5',
                rate: '0.1'
            },
            {
                text: '未中奖6',
                rate: '0.1'
            },
            {
                text: '未中奖7',
                rate: '0.1'
            },
            {
                text: '未中奖8',
                rate: '0.1'
            },
            {
                text: '未中奖7',
                rate: '0.1'
            },
            {
                text: '未中奖8',
                rate: '0.1'
            }
        ];
        var awardIndex = 2;

        var Roulette = {
            container: null,
            canvas: null,
            ctx: null,
            config: {
              id: '',
              width: '200',
              height: '200',
              datas: '',
              awardIndex: 1,
              runTime: 10000,
              timeStart: new Date().getTime(),
              color1: '#F17F42',
              color2: '#CE6D39',
              radius: 80
            },
            init: function (config) {
              this.container = document.getElementById(config.id);
              this.container.style.width = config.width + 'px';
              this.container.style.height = config.height + 'px';

              this.canvas = this.container.getElementsByTagName('canvas')[0];
              this.canvas.setAttribute('width', config.width);
              this.canvas.setAttribute('height', config.height);

              this.config.id = config.id;
              this.config.width = config.width;
              this.config.height = config.height;
              this.config.datas = config.datas;
              this.config.awardIndex = config.awardIndex;

              this.config.radius = (config.width / 2) * 0.8;


              this.ctx = this.canvas.getContext('2d');

              this.ctx.translate(this.config.width / 2, this.config.height / 2);
              this.ctx.save();

              this.draw();

              this.drawPointer();

              this.listenClick();
            },
            draw: function () {
              var startAngle = 0;
              var endAngle = 0;

              for (var i in this.config.datas) {
                this.ctx.save();
                this.ctx.beginPath();

                endAngle = startAngle + this.config.datas[i].rate * 2 * Math.PI;

                if (i % 2 === 0) {
                  this.ctx.fillStyle = this.config.color1;
                  this.ctx.strokeStyle = this.config.color1;
                } else {
                  this.ctx.fillStyle = this.config.color2;
                  this.ctx.strokeStyle = this.config.color2;
                }

                this.ctx.moveTo(0, 0);
                this.ctx.lineTo(this.config.radius * Math.cos(startAngle), this.config.radius * Math.sin(startAngle));
                this.ctx.arc(0, 0, this.config.radius, startAngle, endAngle);
                this.ctx.lineTo(0, 0);
                this.ctx.fill();

                var textAngle = startAngle + (endAngle - startAngle) / 2;
                var textX = (0.8 * this.config.radius) * Math.cos(textAngle);
                var textY = (0.8 * this.config.radius) * Math.sin(textAngle);

                this.ctx.translate(textX, textY);
                this.ctx.rotate(Math.PI / 2 + textAngle);
                this.ctx.font = "14px serif";
                this.ctx.fillStyle = '#FFFFFF';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(this.config.datas[i].text, 0, 0);

                startAngle = endAngle;

                this.ctx.closePath();
                this.ctx.restore();
              }
            },
            drawPointer: function () {
              this.ctx.save();
              this.ctx.beginPath();

              this.ctx.fillStyle = '#FFEEE4';
              this.ctx.arc(0, 0, this.config.width * 0.1, 0, 2 * Math.PI);
              this.ctx.fill();

              this.ctx.moveTo(-this.config.width * 0.04, 0);
              this.ctx.lineTo(0, -this.config.width * 0.2);
              this.ctx.lineTo(this.config.width * 0.04, 0);
              this.ctx.fill();

              this.ctx.fillStyle = '#000000';
              this.ctx.textAlign = 'center';
              this.ctx.textBaseline = 'middle';
              this.ctx.font = '14px serif';
              this.ctx.fillText('开始抽奖', 0, 0);

              this.ctx.closePath();
              this.ctx.restore();
            },
            rotate: function () {
              this.ctx.save();

              var lastTime = this.config.runTime - (new Date().getTime() - this.config.timeStart);

              if (lastTime > 0) {
                this.clear();
                var rotateAngle = this.lastRotateAngle() + 2 * Math.PI - Math.pow(lastTime / 1000, 2) % (2 * Math.PI);
              } else {
                window.cancelAnimationFrame(this.draw);
                return;
              }

              this.ctx.rotate(rotateAngle);

              this.draw();

              this.ctx.restore();

              this.drawPointer();

              window.requestAnimationFrame(this.rotate.bind(this));
            },
            lastRotateAngle: function () {
              var awardAngle = 0;
              for (var i = 0; i < this.config.awardIndex; i++) {
                if (i === this.config.awardIndex - 1) {
                  awardAngle = awardAngle + 2 * Math.PI * (this.config.datas[i].rate / 2);
                } else {
                  awardAngle = awardAngle + 2 * Math.PI * this.config.datas[i].rate;
                }
              }

              return Math.PI * (2 - 1 / 2) - awardAngle;
            },
            clear: function () {
              this.ctx.clearRect(-this.config.width / 2, -this.config.height / 2, this.config.width, this.config.height);
            },
            listenClick: function () {
              this.container.style.position = 'relative';

              var width = this.config.width * 0.2;
              var height = this.config.height * 0.2;

              var clickAreaWrap = document.createElement('div');
              clickAreaWrap.style.height = height + 'px';
              clickAreaWrap.style.width = width + 'px';
              clickAreaWrap.style.position = 'absolute';
              clickAreaWrap.style.top = '50%';
              clickAreaWrap.style.left = '50%';

              var clickAreaInner = document.createElement('div');
              clickAreaInner.style.height = height + 'px';
              clickAreaInner.style.width = width + 'px';
              clickAreaInner.style.marginTop = '-50%';
              clickAreaInner.style.marginLeft = '-50%';

              clickAreaWrap.append(clickAreaInner);

              this.container.append(clickAreaWrap);

              var _this = this;
              clickAreaInner.addEventListener('click', function () {
                _this.rotate();
              })
            }
        };

        Roulette.init({
          id: 'canvas',
          width: 400,
          height: 400,
          datas: datas,
          awardIndex: awardIndex
        });
    </script>
</body>
</html>